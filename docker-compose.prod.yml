services:
  frontend:
    image: ${REGISTRY:-kubrick}/kubrick-frontend:${VERSION:-latest}
    build:
      context: ./kubrick-ui
      args:
        VITE_API_URL: ${VITE_API_URL:-/api}
        VITE_OKTA_ENABLED: ${VITE_OKTA_ENABLED:-false}
    ports:
      - "80:8080"
    depends_on:
      - backend
    restart: always
    networks:
      - kubrick

  backend:
    image: ${REGISTRY:-kubrick}/kubrick-backend:${VERSION:-latest}
    build: ./kubrick-web-service
    # No ports exposed - all traffic goes through frontend nginx proxy
    environment:
      - NODE_ENV=production
      - PORT=3001
      - MONGODB_URI=${MONGODB_URI}
      - GCP_PROJECT_ID=${GCP_PROJECT_ID}
      - GCP_BUCKET_NAME=${GCP_BUCKET_NAME}
      - OKTA_ENABLED=${OKTA_ENABLED:-false}
      - OKTA_ISSUER=${OKTA_ISSUER}
      - OKTA_CLIENT_ID=${OKTA_CLIENT_ID}
      - OKTA_AUDIENCE=${OKTA_AUDIENCE}
      - FRONTEND_URL=${FRONTEND_URL}
      - REDIS_URL=${REDIS_URL}
    restart: always
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    depends_on:
      - redis
    networks:
      - kubrick

  transcoder:
    image: ${REGISTRY:-kubrick}/kubrick-transcoder:${VERSION:-latest}
    build: ./kubrick-transcoder
    environment:
      - NODE_ENV=production
      - REDIS_URL=${REDIS_URL}
      - GCP_PROJECT_ID=${GCP_PROJECT_ID}
      - GCP_BUCKET_NAME=${GCP_BUCKET_NAME}
      - HEARTBEAT_INTERVAL_MS=5000
      - HEARTBEAT_TTL_MS=10000
    restart: always
    depends_on:
      - redis
    deploy:
      replicas: 2
    networks:
      - kubrick

  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes
    restart: always
    volumes:
      - redis_data:/data
    networks:
      - kubrick

networks:
  kubrick:
    driver: bridge

volumes:
  redis_data:
